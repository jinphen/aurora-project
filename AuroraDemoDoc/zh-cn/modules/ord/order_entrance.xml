<sect1 id="purchaseorder-query" revision="1">
    <title>查询界面</title>            
    <para>
		本章节将详细介绍一下如何使用Aurora框架来构建一个订单查询界面。
    </para>
    <sect2 id="purchaseorder-query-create-table" revision="1">
	    <title>建立表结构</title>
	    <para>
			在数据库中创建一张名为PUR_PURCHASE_ORDER_HEADERS的表作为订单头表。其字段主要有订单头ID，公司ID，订单编号，订单日期，订单状态，供应商ID，采购员ID，币种，金额等字段。
	    </para>
	    <programlisting><![CDATA[
Tables
`-- PUR_PURCHASE_ORDER_HEADERS
    `-- Columns
    	|-- PURCHASE_ORDER_HEADER_ID
    	|-- COMPANY_ID
    	|-- ORDER_NUMBER
    	|-- VENDER_ID
    	|-- BUYER_EMPLOYEE_ID
    	|-- ORDER_DATE
    	|-- CURRENCY_CODE
    	|-- TOTAL_AMOUNT
    	`-- STATUS
		 ]]></programlisting>
		<para>
			另外还需要两张表分别是采购员信息表和供应商信息表来作为此表的BUYER_EMPLOYEE_ID和VENDER_ID字段的引用表。
	    </para>
    </sect2>
    <sect2 id="purchaseorder-query-create-bm" revision="1">
	    <title>新建一个BM文件</title>
	    <para>
			在web/WEB-INF/classes路径下的pur目录中新建一个BM文件命名为pur_purchase_order_headers.bm
	    </para>
	    <programlisting><![CDATA[
Project
`-- web
    `-- WEB-INF
    	`-- classes
	        `-- pur
	            `-- pur_purchase_order_headers.bm
		 ]]></programlisting>
		<para>
			bm的基本内容如下：
	    </para>
	    <programlisting><![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
<bm:model xmlns:e="aurora.service.exception" xmlns:o="aurora.database.local.oracle" alias="h" 
	xmlns:bm="http://www.aurora-framework.org/schema/bm" xmlns:f="aurora.database.features"
	baseTable="PUR_PURCHASE_ORDER_HEADERS" defaultOrderBy="order_number" needAccessControl="false">
    <bm:fields>
    </bm:fields>
    <bm:query-fields>
    </bm:query-fields>
    <bm:primary-key>
    	<bm:pk-field name="purchase_order_header_id"/>
    </bm:primary-key>
</bm:model>
		 ]]></programlisting>
		<para>
			在bm:fields标签下增加查询结果字段。
	    </para>
	    <programlisting><![CDATA[
<bm:field name="purchase_order_header_id" databaseType="INT" datatype="java.lang.Long"
	isAutoGeneratedKey="true"/>
<bm:field name="company_id" databaseType="INT" datatype="java.lang.Long"/>
<bm:field name="order_number" databaseType="VARCHAR" datatype="java.lang.String"/>
<bm:field name="vender_id" databaseType="INT" datatype="java.lang.Long"/>
<bm:field name="buyer_employee_id" databaseType="INT" datatype="java.lang.Long"/>
<bm:field name="status" databaseType="VARCHAR" datatype="java.lang.String"/>
<bm:field name="order_date" databaseType="DATE" datatype="java.sql.Date"/>
<bm:field name="currency_code" databaseType="VARCHAR" datatype="java.lang.String"/>
<bm:field name="total_amount" expression="(select sum(l.amount)
		from pur_purchase_order_lines l
		where l.purchase_order_header_id=h.purchase_order_header_id)"
	forInsert="false" forUpdate="false"/>
<bm:field name="status_name" expression="(select d.description_text
		from fnd_descriptions d
		where d.ref_table='SYS_CODE_VALUES'
		and d.ref_field='CODE_VALUE_NAME_ID'
		and d.language='ZHS'
		and d.description_id=(select v.code_value_name_id
			from sys_code_values v
			where v.code_value=h.status
			and code_id=(select c.code_id
				from sys_codes c
				where c.code='SALE_ORD_STATUS')))"
	forInsert="false" forUpdate="false"/>
		 ]]></programlisting>
		<para>
			在bm:query-fields标签下增加查询字段。
	    </para>
	    <programlisting><![CDATA[
<bm:query-field field="purchase_order_header_id" queryOperator="="/>
<bm:query-field name="order_date_from" queryExpression="order_date&gt;=${/parameter/@order_date_from}"/>
<bm:query-field name="order_date_to" queryExpression="order_date&lt;=${/parameter/@order_date_to}"/>
<bm:query-field field="order_number" queryOperator="like"/>
<bm:query-field field="vender_id" queryOperator="="/>
		 ]]></programlisting>
		<para>
			页面中我们需要显示的是供应商的名称和采购员的名字，在bm:model下建立relations和ref-fields。
	    </para>
	    <programlisting><![CDATA[
<bm:relations>
    <bm:relation name="emp" joinType="LEFT OUTER" refAlias="e" refModel="fnd.fnd_employees">
        <bm:reference foreignField="employee_id" localField="buyer_employee_id"/>
    </bm:relation>
    <bm:relation name="partner" joinType="LEFT OUTER" refAlias="p" refModel="inv.fnd_business_partners">
        <bm:reference foreignField="partner_id" localField="vender_id"/>
    </bm:relation>
</bm:relations>
<bm:ref-fields>
    <bm:ref-field name="buyer_employee_name" relationName="emp" sourceField="employee_name"/>
    <bm:ref-field name="vender_name" relationName="partner" sourceField="partner_name"/>
</bm:ref-fields>
		 ]]></programlisting>
	</sect2>
    <sect2 id="purchaseorder-query-create-screen" revision="1">
	    <title>新建一个Screen文件</title>            
	    <para>
			在web/modules路径下的pur目录中新建一个Screen文件命名为pur_purchase_order_entrance.screen
	    </para>
	    <programlisting><![CDATA[
Project
`-- web
    `-- modules
        `-- pur
            `-- pur_purchase_order_entrance.screen
		 ]]></programlisting>
		<para>
			screen的基本内容如下：
	    </para>
	    <programlisting><![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure>
    </a:init-procedure>
    <a:view>
        <script>
        </script>
        <a:dataSets>
        </a:dataSets>
        <a:defaultScreen>
        </a:defaultScreen>
    </a:view>
</a:screen>
		 ]]></programlisting>
		<para>
			在a:dataSets标签下新建一个用于存放查询条件的Dataset#pur_5010_service_query_ds和一个存放查询结果集的Dataset#order_header_ds,
			将pur_5010_service_query_ds设为order_header_ds的queryDataset，order_header_ds设成自动查询，order_header_ds的model设为之前创建的bm。
	    </para>
	    <programlisting><![CDATA[
<a:dataSets>
	<a:dataSet id="pur_5010_service_query_ds"/>
	<a:dataSet id="order_header_ds" autoQuery="true" model="pur.pur_purchase_order_headers"
		queryDataSet="pur_5010_service_query_ds"/>
</a:dataSets>
		 ]]></programlisting>
		<para>
			在a:defaultScreen标签下增加一个查询条件表单，包含一个订单号输入框，可监听回车键来执行查询，也可增加一个按钮来执行查询。除此之外，再增加一个Grid来展示查询到的结果集。
	    </para>
	    <programlisting><![CDATA[
<a:defaultScreen>
	<a:form title="订单查询" width="500">
	    <a:textField name="order_number" bindTarget="pur_5010_service_query_ds" prompt="订单号">
	        <a:events>
	            <a:event name="enterdown" handler="query"/>
	        </a:events>
	    </a:textField>
	</a:form>
	<a:hBox>
	    <a:button click="query" text="查询"/>
	</a:hBox>
	<a:grid id="pur_5010_order_header_grid" bindTarget="order_header_ds" 
		height="350" marginHeight="125" marginWidth="50" navBar="true" width="1160">
	    <a:columns>
	        <a:column name="order_number" align="left" prompt="订单号"
				renderer="pur_5010_main_order_number_render" sortable="true" width="100"/>
	        <a:column name="order_date" align="left" prompt="订单日期"
				renderer="Aurora.formatDate" sortable="true" width="100"/>
	        <a:column name="vender_name" align="left" prompt="供应商"
				sortable="true" width="120"/>
	        <a:column name="currency_code" align="left" prompt="币种"
				sortable="true" width="80"/>
	        <a:column name="total_amount" align="right" prompt="金额"
				renderer="pur_5010_entrance_show_positive_number" sortable="true" width="50"/>
	        <a:column name="buyer_employee_name" align="left" prompt="采购员"
				sortable="true" width="50"/>
	        <a:column name="status_name" align="left" prompt="状态"
				sortable="true" width="50"/>
	    </a:columns>
	</a:grid>
</a:defaultScreen>
		 ]]></programlisting>
		<para>
			通过以上几步，生成以下的页面效果：
		</para>
		<mediaobject>
        	<imageobject role="fo">
	            <imagedata fileref="images/purchase_query.jpg" format="JPG" width="371" depth="302" contentwidth="374" contentdepth="227"/>
	        </imageobject>
	        <imageobject role="html">
	            <imagedata fileref="../shared/images/purchase_query.jpg" format="JPG"/>
	        </imageobject>
	    </mediaobject>    
	</sect2>
</sect1>